<html>
	<head>
		<title>User Check In</title>
		<link rel="icon" href="">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
		<script src="/cdn/api.js" crossorigin="anonymous"></script>
		<script src="/cdn/utils.js" crossorigin="anonymous"></script>
		<script src="/cdn/ui.js" crossorigin="anonymous"></script>
	</head>
	<body>
		<br>
		<div class="container">
			<div class="row" id="search-row">
				<div class="col-md-2"></div>
				<div class="col-md-8">
					<div class="input-group mb-3">
						<button class="btn btn-outline-secondary" type="button" id="search-button">Search</button>
						<input id="user-search-input" type="text" class="form-control flex-grow-1">
					</div>
				</div>
				<div class="col-md-2"></div>
			</div>
			<br>
			<div class="row" id="buttons-row">
				<center>
					<button id="check-in-button" type="submit" class="btn btn-primary">Check-In</button>
					<button id="edit-user-button" type="submit" class="btn btn-success">Edit</button>
				</center>
			</div>
			<br>
			<div class="row" id="main-row"></div>
		</div>
		<script>

			// http://localhost:5950/admin/user/edit/001393f1-0d0f-4b19-a690-f5bfceb28415

			async function render_active_user( event ) {
				$( "#edit-user-button" ).show();
				let check_in_test = await check_in_uuid_test( typed_input );
				console.log( check_in_test );
				window.check_in_test = check_in_test;

				let shopping_for_elem = document.getElementById( "shopping_for" );
				console.log( "Family Size ===" + check_in_test[ "family_size" ] );
				let shopping_for_value = check_in_test[ "family_size" ];
				if ( shopping_for_value > 1 ) { shopping_for_value += 1; }
				// let shopping_for_value = ( parseInt( check_in_test[ "family_size" ] ) + 1 ); // plus 1 for self // TODO : clean this up
				console.log( "Shopping For ===" , shopping_for_value )
				$( "#shopping_for" ).val( shopping_for_value );
				// const shopping_for_options_to_hide = shopping_for_elem.querySelectorAll( `option[value > "${check_in_test[ "family_size" ]}"]` );
				const shopping_for_options_to_hide =  Array.from( shopping_for_elem.options ).filter( option => option.value > shopping_for_value );
				shopping_for_options_to_hide.forEach( option => { option.style.display = 'none'; } );


				populate_user_balance_table( check_in_test[ "balance" ] );

				$( "#check-in-button-row" ).show();
				$( "#active-user-row" ).show();
				switch ( check_in_test[ "result" ] ) {
					case true:
						// $( "#active-username" ).text( `${check_in_test[ "name_string" ]} || Family Size = ${check_in_test[ "family_size" ]}` );
						$( "#active-username" ).text( `${check_in_test[ "name_string" ]}` );
						$( "#active-username-time" ).text( "" );
						$( "#user-balance-table" ).removeClass( "table-danger" );
						$( "#user-balance-table" ).addClass( "table-success" );
						// $( "#checked-in-alert-true" ).slideDown();
						$( "#checked-in-alert-false" ).slideUp();
						// setTimeout( function() {
						// 	$( "#checked-in-alert-true" ).slideUp();
						// 	// $( "#user-search-input" ).val( "" );
						// } , 3000 );
						window.check_in_input.focus();
						break;
					case false:
						let time_remaining_string = convert_milliseconds_to_time_string( check_in_test[ "time_remaining" ] );
						$(  )
						// $( "#active-username" ).text( `${check_in_test[ "name_string" ]} || Family Size = ${check_in_test[ "family_size" ]}` );
						$( "#active-username" ).text( `${check_in_test[ "name_string" ]}` );
						$( "#active-username-time" ).text( `Needs to wait ${time_remaining_string}` );
						$( "#user-balance-table" ).removeClass( "table-success" );
						$( "#user-balance-table" ).addClass( "table-danger" );
						$( "#checked-in-alert-true" ).slideUp();
						$( "#checked-in-alert-false" ).slideDown();
						break;
				}
			}

			async function check_in_uuid_input( event ) {
				if ( event ) { event.preventDefault(); }
				let typed_input = window.check_in_input.value;

				let balance_table = document.getElementById( "user-balance-table-body" );
				let balance_inputs = balance_table.querySelectorAll( "input" );

				let form_data = { "uuid": typed_input };
				for ( let i = 0; i < balance_inputs.length; ++i ) {
					form_data[ balance_inputs[ i ].id ] = parseInt( balance_inputs[ i ].value );
				}
				let valid_check_in = await check_in_uuid( typed_input , form_data );
				console.log( `${typed_input} === Checked In === ${valid_check_in}` );

				reset_search_form();
			}

			// function on_override_button_click( event ) {
			// 	event.preventDefault();
			// 	alert( "Not Implemented Yet !!!" );
			// 	// TODO : call backend "/admin/user/checkin/override/${uuid}"
			// 	$( "#checked-in-alert-false" ).slideUp();
			// 	window.check_in_input.value = "";
			// 	window.check_in_input.focus();
			// }

			function on_shopping_for_select_change( event ) {
				console.log( "on_shopping_for_select_change()" );
				populate_user_balance_table( window.check_in_test[ "balance" ] );
			}

			function on_edit_user_button_click( event ) {
				event.preventDefault();
				window.open( `/admin/user/edit/${window.check_in_input.value}` , "_blank" );
				window.focus();
			}

			function on_block_button_click( event ) {
				event.preventDefault();
				reset_search_form();
			}

			class MCT_UI {
				constructor( options={} ) {
					this.options = options;
					this.stack = options.stack;
					this.buttons = options.buttons;
					this.ids = {};
					for ( let key in this.options.ids ) {
						this.ids[ key ] = {
							name: key ,
							visible: false ,
							render: this.options.ids[ key ] ,
							// populate?: this.options.ids[ key ]() , // TODO ?
							// html: "" ,
						}
					}
				}
				clear() {
					$( this.options.anchor ).html( "" );
				}
				hide_all_buttons() {
					for ( let i = 0; i < this.buttons.length; ++i ) {
						$( this.buttons[ i ] ).hide();
					}
				}
				render() {
					let new_ui_stack = [];
					Object.keys( this.ids ).forEach( x => this.ids[ x ].visible = false );
					for ( let i = 0; i < this.stack.length; ++i ) {
						let x_id = this.ids[ this.stack[ i ] ];
						let html = x_id.render();
						x_id.visible = true;
						new_ui_stack.push( html );
						new_ui_stack.push( "<br><br>" );
					}
					let new_ui_stack_html_string = new_ui_stack.join( " " );
					$( this.options.anchor ).html( new_ui_stack_html_string );
				}
			}

			let timeout_id;
			const debounce_time = 200;
			async function on_check_in_input_change( event ) {
				if ( event ) { event.preventDefault(); }
				clearTimeout( timeout_id );
				let typed_input = event.target.value;
				if ( typed_input.length < 2 ) { return; }
				timeout_id = setTimeout( async () => {
					let valid_uuid = is_uuid( typed_input );
					if ( valid_uuid ) {
						let user = await get_user_from_uuid( typed_input );
						if ( user ) {
							window.USER = user;
							render_active_user();
						}
						return;
					}
					let valid_barcode = is_barcode( typed_input );
					if ( valid_barcode ) {
						let user = await get_user_from_barcode( typed_input );
						if ( user ) {
							window.USER = user;
							render_active_user();
						}
						return;
					}
					console.log( `Not a UUID , Not a Barcode , Searching : ${typed_input}` );
					let search_results = await fuzzy_search_username( typed_input );
					if ( search_results.length < 1 ) {
						window.UI.clear();
						return;
					}
					window.UI.stack = [ "user_search_table" ];
					window.UI.render();
					populate_user_search_table( search_results );
				} , debounce_time );
			}

			async function init() {

				window.UI = new MCT_UI({
					anchor: "#main-row" ,
					// stack: [ "user_balance_table" , "user_search_table" , "shopping_for_selector" , "alert_check_in_allowed" , "alert_check_in_failed" ] ,
					stack: [] ,
					ids: {
						"alert_check_in_allowed": get_ui_alert_check_in_allowed ,
						"alert_check_in_failed": get_ui_alert_check_in_failed ,
						"shopping_for_selector": get_ui_shopping_for_selector ,
						// "user_search_results_table": get_ui_user_search_results_table ,
						// "user_edit_form": get_ui_user_edit_form ,
						"user_search_table": get_ui_user_search_table ,
						"user_balance_table": get_ui_user_balance_table ,
					} ,
					buttons: [
						"#check-in-button" ,
						"#edit-user-button" ,
					] ,
				});
				window.UI.hide_all_buttons();

				let check_in_input = document.getElementById( "user-search-input" );
				check_in_input.addEventListener( "input" , on_check_in_input_change );
				// check_in_input.addEventListener( "keydown" , ( event ) => {
				// 	if ( event.keyCode === 13 ) {
				// 		// check_in_uuid_input( event );
				// 		search_input( event );
				// 	}
				// });
				// const block_button = document.getElementById( "block-button" );
				// block_button.addEventListener( "click" , on_block_button_click );
				// // const override_button = document.getElementById( "override-button" );
				// // override_button.addEventListener( "click" , on_override_button_click );

				// const search_button = document.getElementById( "search-button" );
				// search_button.addEventListener( "click" , search_input );

				// const edit_user_button = document.getElementById( "edit-user-button" );
				// edit_user_button.addEventListener( "click" , on_edit_user_button_click );

				// const shopping_for_select = document.getElementById( "shopping_for" );
				// shopping_for_select.addEventListener( "change" , on_shopping_for_select_change );
			}
			document.addEventListener( "DOMContentLoaded" , init );
		</script>
	</body>
</html>