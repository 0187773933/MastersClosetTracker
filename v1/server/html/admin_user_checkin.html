<html>
	<head>
		<title>User Check In</title>
		<link rel="icon" href="">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="col-sm">
					<center><h1>Check In Users Here</h1></center>
				</div>
			</div>
			<br><br>
			<div class="row">
				<div class="col-sm">
					<div class="form-group d-flex">
						<input id="check-in-input" type="text" class="form-control flex-grow-1">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm">
					<div class="alert alert-success" id="checked-in-alert-true">
						User Checked In !!!
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm">
					<div class="alert alert-danger" id="checked-in-alert-false">
						<center>
							<a id="override-button" class="btn btn-success" target="_blank" href="/none">Allow</a>
							&nbsp; User Checked In Too Recently !!! &nbsp;
							<a id="block-button" class="btn btn-warning" target="_blank" href="/none">Block</a>
						</center>
					</div>
				</div>
			</div>
		</div>
		<script>

			const uuid_v4_regex = /^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i
			function is_uuid( str ) { return uuid_v4_regex.test( str ); }

			function check_in_uuid( uuid ) {
				return new Promise( async function( resolve , reject ) {
					try {
						let check_in_url = `/admin/user/checkin/${uuid}`;
						let check_in_response = await fetch( check_in_url , {
							method: "GET" ,
							headers: { "Content-Type": "application/json" }
						});
						let response_json = await check_in_response.json();
						let result = response_json[ "result" ];
						resolve( result );
						return;
					}
					catch( error ) { console.log( error ); reject( error ); return; }
				});
			}

			async function check_uuid_input() {
				const typed_uuid = window.check_in_input.value;
				const valid_uuid = is_uuid( typed_uuid );
				if ( valid_uuid === false ) { alert( "Not a Valid UUID !!!" ); return; }
				let valid_check_in = await check_in_uuid( typed_uuid );
				console.log( `${typed_uuid} === ${valid_uuid} === Checked In === ${valid_check_in}` );
				switch ( valid_check_in ) {
					case true:
						$( "#checked-in-alert-true" ).slideDown();
						$( "#checked-in-alert-false" ).slideUp();
						setTimeout( function() {
							$( "#checked-in-alert-true" ).slideUp();
							$( "#check-in-input" ).val( "" );
						} , 3000 );
						window.check_in_input.focus();
						break;
					case false:
						$( "#checked-in-alert-true" ).slideUp();
						$( "#checked-in-alert-false" ).slideDown();
						break;
				}

			}

			function on_override_button_click( event ) {
				event.preventDefault();
				alert( "Not Implemented Yet !!!" );
				// TODO : call backend "/admin/user/checkin/override/${uuid}"
				$( "#checked-in-alert-false" ).slideUp();
				window.check_in_input.value = "";
				window.check_in_input.focus();
			}

			function on_block_button_click( event ) {
				event.preventDefault();
				$( "#checked-in-alert-false" ).slideUp();
				window.check_in_input.value = "";
				window.check_in_input.focus();
			}

			function init() {
				// $( "#check-in-input" ).focus();
				window.check_in_input = document.getElementById( "check-in-input" );
				$( "#checked-in-alert-true" ).slideUp();
				$( "#checked-in-alert-false" ).slideUp();
				window.check_in_input.value = "";
				window.check_in_input.focus();
				// check_in_input.addEventListener( "input" , on_check_in_input_change );
				check_in_input.addEventListener( "keydown" , ( event ) => {
					if ( event.keyCode === 13 ) {
						check_uuid_input( event );
					}
				});
				const block_button = document.getElementById( "block-button" );
				block_button.addEventListener( "click" , on_block_button_click );
				const override_button = document.getElementById( "override-button" );
				override_button.addEventListener( "click" , on_override_button_click );
			}
			document.addEventListener( "DOMContentLoaded" , init );
		</script>
	</body>
</html>